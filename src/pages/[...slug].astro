---
import { useStoryblokApi } from "@storyblok/astro";
import StoryblokComponent from "@storyblok/astro/StoryblokComponent.astro";
import Layout from "../layouts/Layout.astro"; // Assuming you have a default Layout

export const prerender = false; // Important: Disables static generation for dynamic routes

const storyblokApi = useStoryblokApi();

// Get the slug from the URL parameters, default to 'home'
const slug = Array.isArray(Astro.params.slug) 
  ? Astro.params.slug.join('/') 
  : 'home';

// Fetch the story data
const { data } = await storyblokApi.get(`cdn/stories/${slug}`, {
  // Use 'draft' version during development for the Visual Editor
  version: import.meta.env.DEV ? "draft" : "published",
});

// If the story doesn't exist, handle the 404
if (!data.story) {
  return Astro.redirect('/404'); 
}

const story = data.story;
---

<Layout title={story.content.title}>
  <StoryblokComponent blok={story.content} />
</Layout>
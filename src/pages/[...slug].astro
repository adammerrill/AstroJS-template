---
/**
 * @fileoverview Universal Storyblok Entry Point
 * @description Handles all dynamic content routes.
 * Uses the "Safe Fetch" pattern to gracefully handle 404s and API errors.
 * Implements the Storyblok Bridge for real-time visual editing.
 */

 import StoryblokComponent from "@storyblok/astro/StoryblokComponent.astro";
import BaseLayout from "../layouts/BaseLayout.astro";
import { getSafeStory } from "../lib/storyblok";
import type { SbBlokData } from "@storyblok/astro";

// 1. Force Server-Side Rendering (SSR) for dynamic updates
export const prerender = false;

// 2. Resolve URL Slug
const { slug } = Astro.params;
// Storyblok expects 'home' for the root path, not undefined/empty
const path = slug === undefined ? "home" : slug;

// 3. Safe Fetch with Type Definition
const { story, error, status } = await getSafeStory<SbBlokData>(path);

// 4. Error Handling Boundary
if (!story || error) {
  console.warn(`[Route Error] Could not load slug "${path}":`, error);
  
  if (status === 404) {
    return Astro.redirect("/404");
  }
  
  // For 500s, we throw to let the Astro error overlay handle it in dev
  throw new Error(`Critical CMS Failure: ${error?.message}`);
}

// Safely extract title with type assertion
const contentTitle = story.content?.title as string | undefined;
const pageTitle = contentTitle ?? story.name ?? "Astro Enterprise";
---

<BaseLayout title={pageTitle}>
  <StoryblokComponent blok={story.content} />
</BaseLayout>
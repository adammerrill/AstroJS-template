---
// src/pages/[...slug].astro
/**
 * @fileoverview Universal Storyblok Entry Point
 * @description Handles all dynamic content routes.
 * Uses the "Safe Fetch" pattern to gracefully handle 404s and API errors.
 * Implements the Storyblok Bridge for real-time visual editing.
 *
 * @module pages/dynamic
 * @version 1.1.3
 */

 import StoryblokComponent from "@storyblok/astro/StoryblokComponent.astro";
import Layout from "../layouts/Layout.astro";
import { getSafeStory } from "../lib/storyblok";
import type { SbBlokData } from "@storyblok/astro";
import { useStoryblokApi } from "@storyblok/astro";
import type { ISbStoriesParams } from "@storyblok/astro";

/**
 * @function getStaticPaths
 * @description CRITICAL: Fetches all published links from Storyblok's link API
 * and generates a static route for every page. Ensures resilience by providing 
 * a fallback path for the root ('/').
 *
 * @returns {Promise<Array<{ params: { slug: string | undefined } }>>}
 */
export async function getStaticPaths(): Promise<Array<{ params: { slug: string | undefined } }>> {
  const storyblokApi = useStoryblokApi();
  
  // Always include home (/) as a mandatory path.
  const fallbackPaths = [{ params: { slug: undefined } }]; 
  
  try {
    // Fetch links using the links endpoint for speed and efficiency (CDN Caching)
    const { data } = await storyblokApi.get('cdn/links', {
      version: 'published',
    } as ISbStoriesParams); 

    const links = Object.values(data.links) as any[];

    const generatedPaths = links
      .filter((link: any) => !link.is_folder && link.slug !== 'home')
      .map((link: any) => ({
        // Map slug to params object for Astro's routing engine
        params: { slug: link.slug },
      }));

    // Combine generated paths with the mandatory home path
    return [...generatedPaths, ...fallbackPaths];

  } catch (error) {
    console.error("[getStaticPaths] Links API failed. Proceeding with fallback paths only.", error);
    // In case of a failure (like the current 404), ensure we still build the root page
    return fallbackPaths;
  }
}

// 2. Resolve URL Slug
const { slug } = Astro.params;
// Storyblok expects 'home' for the root path, not undefined/empty
const path = slug === undefined ? "home" : slug;

// 3. Safe Fetch with Type Definition
// The version check relies on the Storyblok Visual Editor query parameter (`_storyblok`)
const isDraft = Astro.url.searchParams.get('_storyblok') || import.meta.env.DEV;
const version = isDraft ? "draft" : "published";

const { story, error, status } = await getSafeStory<SbBlokData>(path, { version });

// 4. Error Handling Boundary
if (!story || error) {
  console.warn(`[Route Error] Could not load slug "${path}":`, error);
  
  if (status === 404) {
    if (import.meta.env.DEV) {
      // In dev mode, redirect to the dev 404 page for better debugging UX
      return Astro.redirect("/404");
    }
  }
  
  // For 500s or other critical failures, throw a runtime error during the build for immediate feedback
  if (status >= 500) {
     throw new Error(`Critical CMS Failure during build: ${error?.message}`);
  }
}

// Safely extract title with type assertion
const contentTitle = story?.content?.title as string | undefined;
const pageTitle = contentTitle ?? story?.name ?? "Astro Enterprise";
---

<Layout title={pageTitle}>
  {story?.content && <StoryblokComponent blok={story.content} />}
  
  <!-- Fallback for content-less pages during SSG build, ensures the build completes -->
  {!story?.content && (
    <section class="container mx-auto px-4 py-20 text-center">
        <h1 class="text-9xl font-extrabold tracking-widest text-primary">404</h1>
        <div class="bg-secondary px-2 text-sm rounded rotate-12 absolute">
          BUILD-TIME FALLBACK (404 Page Content Missing)
        </div>
        <p class="mt-8 text-lg text-muted-foreground">
          Content missing during build. Check Storyblok.
        </p>
    </section>
  )}
</Layout>

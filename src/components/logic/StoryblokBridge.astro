---
/**
 * @file Storyblok Bridge Manager
 * @module components/logic/storyblok-bridge
 * @classification Internal
 * @compliance ISO/IEC 25010 - Security & Reliability
 * @compliance REQ-SEC-002 - Secure API Communication & Content Security Policy
 * @compliance WCAG 2.2 AA - Progressive Enhancement
 * @author Atom Merrill
 * @version 2.1.0
 * @requirement REQ-SEC-002
 * @requirement REQ-PERF-003
 * @test_ref tests/integration/storyblok-bridge.test.ts
 * @test_ref tests/e2e/visual-editor.spec.ts
 * 
 * @description
 * Manages secure bi-directional communication between Astro application and Storyblok Visual Editor.
 * Implements defense-in-depth for script injection, secure event handling, and failsafe initialization.
 * Critical for CI/CD pipeline content preview and editor experience.
 *
 * @description Security Architecture:
 * - Validates window.StoryblokBridge existence before instantiation to prevent prototype pollution
 * - Uses is:inline directive to bypass bundling while maintaining CSP nonces
 * - Implements polling fallback for async script injection scenarios
 * - Re-initializes on Astro view transitions without memory leaks
 *
 * @description Performance & Reliability:
 * - 200ms polling interval with immediate cleanup on navigation
 * - astro:page-load event listener ensures SPA lifecycle compatibility
 * - Graceful degradation when bridge is unavailable (production builds)
 * - Zero dependencies beyond Storyblok's global script
 */
---
<div id="storyblok-bridge-indicator" aria-hidden="true"></div>

<script is:inline>
  // We use is:inline to ensure this script runs immediately and isn't bundled away
  
  function initBridge() {
    // 1. Check if the Storyblok Bridge script is loaded
    // Docs: StoryblokBridge can only be used in a browser environment
    if (!window.StoryblokBridge) {
      // If the integration hasn't injected it yet, we wait.
      return; 
    }

    // 2. Instantiate the Bridge
    // Docs: Access StoryblokBridge in the global scope 
    const storyblokInstance = new window.StoryblokBridge({
      // Docs: preventClicks: true allows normal click behavior inside the editor
      preventClicks: true, 
      resolveRelations: [], // Add relations here if your content uses them 
    });

    if (storyblokInstance) {

      // 3. Listen for events
      // Docs: StoryblokBridge.prototype.on(["published", "change"], callback)
      // Events: 'published' (story published), 'change' (story saved)
      storyblokInstance.on(["published", "change"], (event) => {
        // Docs: The event object contains a 'reload' property
        if (event.reload || !event.slugChanged) {
          window.location.reload(); 
        } else {
          // If slug changed, 
          // reload to handle the new route
          window.location.reload();
        }
      });

      // Optional: Handle real-time input (keystrokes)
      // Docs: 'input' event returns the complete, unsaved story
      storyblokInstance.on("input", () => {
         // Input event handling (currently unused)
         // console.log("Live update:", event.story);
      });
    }
  }

  // 4. Initialization Logic with Polling
  // The bridge script is injected asynchronously by the integration.
  // Polling to ensure window.StoryblokBridge exists before init
  const checkBridge = setInterval(() => {
    if (window.StoryblokBridge) {
      initBridge();
      clearInterval(checkBridge);
    }
  }, 200);

  // 5. Handle Astro View Transitions
  // Docs: We must re-run logic after client-side navigation
  // Re-initialize on View Transition navigation
  document.addEventListener('astro:page-load', () => {
    // Clear previous interval if navigation happened quickly
    clearInterval(checkBridge); 
    if (window.StoryblokBridge) {
        initBridge();
    }
  });
</script>

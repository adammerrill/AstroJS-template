---
/**
 * @file Global Header Component
 * @module components/ui/Header
 * @classification Public
 * @compliance ISO 9241-11 (Usability) - Navigation Accessibility
 * @compliance WCAG 2.1 Level AA - Focus Management & Contrast
 * @author Atom Merrill
 * @version 1.2.0
 * @requirement REQ-UI-001
 * @test_ref tests/e2e/navigation.spec.ts
 *
 * @description
 * The primary navigation controller for the application.
 * Implements a responsive "Drawer" pattern for mobile viewports using
 * Tailwind v4 state modifiers (`group-data`) instead of custom CSS.
 *
 * @accessibility
 * - Implements ARIA `dialog` pattern for mobile menu
 * - Manages focus trapping via `initDrawer` script
 * - locks body scroll to prevent background scrolling
 *
 * @dependencies
 * - Storyblok Global Settings (Navigation Links)
 * - Tailwind v4 (State Modifiers)
 */

import type { GlobalSettings, NavigationItem } from "@/types/storyblok";
import { resolveLink } from "@/types/storyblok";

interface Props {
  /** Global settings fetched from Storyblok */
  settings?: GlobalSettings | null;
}

const { settings } = Astro.props;
const currentPath = Astro.url.pathname;

/**
 * Fallback navigation links if CMS data is unavailable.
 * Ensures the header remains functional during API outages.
 */
const defaultLinks: NavigationItem[] = [
  { _uid: "d1", name: "Home", link: { cached_url: "/" } },
  { _uid: "d2", name: "Services", link: { cached_url: "services" } },
  { _uid: "d3", name: "About", link: { cached_url: "about" } },
  { _uid: "d4", name: "Blog", link: { cached_url: "blog" } },
];

const navLinks = settings?.header_nav || defaultLinks;
---

<header
  id="main-header"
  class="header-glass sticky top-0 z-50 w-full transition-all duration-300 ease-in-out"
>
  <div
    class="mx-auto flex h-16 max-w-7xl items-center justify-between px-4 py-4 bp1020:px-6"
  >
    <div class="flex flex-1 items-center gap-4">
      <a
        href="/"
        class="focus-visible:ring-ring focus-visible:ring-offset-2 group flex shrink-0 items-center space-x-2 rounded-lg focus-visible:outline-none focus-visible:ring-2"
        aria-label="Go to Homepage"
      >
        <svg
          width="28"
          height="28"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
          class="text-primary transition-transform group-hover:scale-110"
        >
          <path
            d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"></path>
        </svg>
        <span
          class="text-foreground hidden text-lg font-bold transition-colors group-hover:text-foreground/80 bp1020:inline-block"
        >
          {settings?.site_title || "Astro Template"}
        </span>
      </a>

      <nav
        class="hidden items-center gap-6 ml-8 bp1020:flex"
        data-testid="desktop-nav"
      >
        {
          navLinks.map((item) => {
            const href = resolveLink(item.link);
            const isActive =
              currentPath === href ||
              (href !== "/" && currentPath.startsWith(href));
            return (
              <a
                href={href}
                class={`text-sm font-medium transition-colors hover:text-foreground/80 ${
                  isActive ? "text-foreground" : "text-foreground/60"
                }`}
              >
                {item.name}
              </a>
            );
          })
        }
      </nav>
    </div>

    <div class="flex shrink-0 items-center gap-6">
      <a
        href="/get-started"
        class="btn-primary inline-flex items-center justify-center whitespace-nowrap"
        data-testid="header-cta"
      >
        Get Started
      </a>

      <button
        id="mobile-menu-button"
        class="flex h-10 w-10 shrink-0 items-center justify-center p-0 bp1020:hidden"
        aria-label="Open navigation menu"
        aria-expanded="false"
        aria-controls="mobile-drawer"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="pointer-events-none"
        >
          <line x1="4" x2="20" y1="12" y2="12"></line>
          <line x1="4" x2="20" y1="6" y2="6"></line>
          <line x1="4" x2="20" y1="18" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>
</header>

<div
  id="mobile-drawer"
  class="group/drawer fixed inset-0 z-60 pointer-events-none bp1020:hidden"
  role="dialog"
  aria-modal="true"
  aria-labelledby="drawer-title"
  aria-hidden="true"
  data-state="closed"
  data-testid="mobile-drawer"
>
  <div
    id="drawer-backdrop"
    class="bg-background/80 absolute inset-0 opacity-0 backdrop-blur-lg transition-opacity duration-300 group-data-[state=open]/drawer:pointer-events-auto group-data-[state=open]/drawer:opacity-100"
    aria-hidden="true"
  >
  </div>

  <div
    class="bg-background/95 border-border/40 absolute top-0 right-0 flex h-full w-full max-w-md translate-x-full transform flex-col border-l backdrop-blur-lg transition-transform duration-300 ease-in-out group-data-[state=open]/drawer:pointer-events-auto group-data-[state=open]/drawer:translate-x-0"
    id="drawer-panel"
  >
    <div
      class="border-border/40 flex items-center justify-between border-b p-4"
    >
      <h2 id="drawer-title" class="text-foreground text-lg font-semibold">
        Menu
      </h2>
      <button
        id="drawer-close-button"
        class="btn-ghost h-10 w-10 p-0"
        aria-label="Close navigation menu"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          ><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg
        >
      </button>
    </div>

    <div class="flex flex-1 flex-col justify-between p-4">
      <nav class="flex flex-col space-y-2">
        {
          navLinks.map((item) => {
            const href = resolveLink(item.link);
            const isActive = currentPath === href;
            return (
              <a
                href={href}
                class={`rounded-lg px-4 py-3 text-base font-medium transition-colors hover:bg-accent hover:text-accent-foreground ${
                  isActive
                    ? "bg-accent text-accent-foreground"
                    : "text-foreground/70"
                }`}
              >
                {item.name}
              </a>
            );
          })
        }
      </nav>

      <div class="border-border/40 mt-auto space-y-4 border-t pt-4">
        <a
          href="/get-started"
          class="btn-primary w-full justify-center"
          data-testid="drawer-cta"
        >
          Get Started
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  /**
   * Mobile drawer initialization logic.
   * Handles state toggling and focus management compliant with WCAG 2.1.
   */
  const initDrawer = () => {
    const button = document.getElementById("mobile-menu-button");
    const drawer = document.getElementById("mobile-drawer");
    const panel = document.getElementById("drawer-panel");
    const backdrop = document.getElementById("drawer-backdrop");
    const closeBtn = document.getElementById("drawer-close-button");

    if (!button || !drawer || !panel || !backdrop || !closeBtn) return;

    const getFocusableElements = (): HTMLElement[] => {
      const selector =
        'a[href], button:not([disabled]), [tabindex]:not([tabindex="-1"])';
      return Array.from(panel.querySelectorAll(selector));
    };

    let previousFocusedElement: HTMLElement | null = null;

    const open = () => {
      previousFocusedElement = document.activeElement as HTMLElement;
      drawer.setAttribute("data-state", "open");
      drawer.setAttribute("aria-hidden", "false");
      // Note: pointer-events are now handled by CSS classes via data-state
      button.setAttribute("aria-expanded", "true");
      document.body.style.overflow = "hidden";

      requestAnimationFrame(() => {
        // Focus management
        requestAnimationFrame(() => {
          closeBtn.focus();
        });
      });
    };

    const close = () => {
      drawer.setAttribute("data-state", "closed");
      drawer.setAttribute("aria-hidden", "true");
      button.setAttribute("aria-expanded", "false");
      document.body.style.overflow = "";

      if (previousFocusedElement) {
        previousFocusedElement.focus();
        previousFocusedElement = null;
      }
    };

    const handleKeyDown = (e: KeyboardEvent) => {
      const isOpen = drawer.getAttribute("data-state") === "open";
      if (!isOpen) return;

      if (e.key === "Escape") {
        e.preventDefault();
        close();
        return;
      }

      if (e.key === "Tab") {
        const focusableElements = getFocusableElements();
        if (focusableElements.length === 0) return;

        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];

        if (e.shiftKey) {
          if (document.activeElement === firstElement) {
            e.preventDefault();
            lastElement.focus();
          }
        } else {
          if (document.activeElement === lastElement) {
            e.preventDefault();
            firstElement.focus();
          }
        }
      }
    };

    button.onclick = open;
    closeBtn.onclick = close;
    backdrop.onclick = close;
    document.addEventListener("keydown", handleKeyDown);
  };

  document.addEventListener("astro:page-load", initDrawer);
  initDrawer();
</script>

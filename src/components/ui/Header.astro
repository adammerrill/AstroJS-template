---
/**
 * @file Header.astro
 * @description Global Header component with responsive navigation.
 *              Implements accessible mobile drawer with focus management,
 *              keyboard navigation, and proper ARIA attributes.
 * 
 * Features:
 * - Responsive breakpoint at 1020px (bp1020 Tailwind variant)
 * - Mobile drawer with backdrop blur and focus trap
 * - Dynamic navigation from Storyblok Global Settings
 * - Keyboard accessibility (Escape to close, Tab cycling)
 * - Body scroll lock when drawer is open
 * 
 * @requires @storyblok/astro
 * @requires GlobalSettings type definition
 * @see {@link https://www.w3.org/WAI/ARIA/apg/patterns/dialog-modal/}
 */
 import type { GlobalSettings } from "@/types/storyblok";

interface Props {
  settings?: GlobalSettings | null;
}

const { settings } = Astro.props;
const currentPath = Astro.url.pathname;

/**
 * Default navigation links used as fallback when Storyblok settings
 * are unavailable or empty.
 * @constant
 */
const defaultLinks = [
  { name: "Home", link: { url: "/" } },
  { name: "Services", link: { url: "/services" } },
  { name: "About", link: { url: "/about" } },
  { name: "Blog", link: { url: "/blog" } },
];

const navLinks = settings?.header_nav || defaultLinks;

/**
 * Resolves Storyblok link objects to URL strings.
 * Handles both internal (cached_url) and external (url) links.
 * 
 * @param {any} link - Storyblok link object
 * @returns {string} Resolved URL path
 */
const getHref = (link: any) => {
  return link.cached_url ? `/${link.cached_url}` : link.url || '#';
};
---

<header 
  id="main-header"
  class="sticky top-0 z-50 w-full header-glass transition-all duration-300 ease-in-out"
>
  <div class="mx-auto flex h-16 max-w-7xl items-center justify-between px-4 bp1020:px-6 py-4">
    <!-- LEFT GROUP: Logo + Navigation -->
    <div class="flex flex-1 items-center gap-4">
      <!-- Logo Mark -->
      <a 
        href="/" 
        class="flex items-center space-x-2 group focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 rounded-lg shrink-0"
      >
        <svg 
          width="28" 
          height="28" 
          viewBox="0 0 24 24" 
          fill="none" 
          xmlns="http://www.w3.org/2000/svg"
          class="text-primary transition-transform group-hover:scale-110"
        >
          <path 
            d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" 
            stroke="currentColor" 
            stroke-width="2" 
            stroke-linecap="round" 
            stroke-linejoin="round"
          />
        </svg>
        <span class="hidden bp1020:inline-block font-bold text-lg text-foreground group-hover:text-foreground/80 transition-colors">
          {settings?.site_title || "Astro Template"}
        </span>
      </a>
      
      <!-- Desktop Navigation -->
      <nav class="hidden bp1020:flex items-center gap-6 ml-8" data-testid="desktop-nav">
        {navLinks.map((item) => {
          const href = getHref(item.link);
          const isActive = currentPath === href || (href !== '/' && currentPath.startsWith(href));
          return (
            <a
              href={href}
              class={`text-sm font-medium transition-colors hover:text-foreground/80 ${
                isActive ? 'text-foreground' : 'text-foreground/60'
              }`}
            >
              {item.name}
            </a>
          );
        })}
      </nav>
    </div>
    
    <!-- RIGHT GROUP: CTA + Hamburger -->
    <div class="flex items-center gap-6 shrink-0">
      <a 
        href="/get-started" 
        class="btn-primary inline-flex items-center justify-center whitespace-nowrap"
        data-testid="header-cta"
      >
        Get Started
      </a>
      
      <button 
        id="mobile-menu-button"
        class="flex items-center justify-center w-10 h-10 p-0 shrink-0 bp1020:hidden"
        aria-label="Open navigation menu"
        aria-expanded="false"
        aria-controls="mobile-drawer"
      >
        <svg 
          xmlns="http://www.w3.org/2000/svg" 
          width="24" 
          height="24" 
          viewBox="0 0 24 24" 
          fill="none" 
          stroke="currentColor" 
          stroke-width="2" 
          stroke-linecap="round" 
          stroke-linejoin="round"
          class="pointer-events-none"
        >
          <line x1="4" x2="20" y1="12" y2="12"></line>
          <line x1="4" x2="20" y1="6" y2="6"></line>
          <line x1="4" x2="20" y1="18" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>
</header>

<!-- Mobile Drawer -->
<div 
  id="mobile-drawer"
  class="fixed inset-0 z-60 bp1020:hidden pointer-events-none"
  role="dialog"
  aria-modal="true"
  aria-labelledby="drawer-title"
  aria-hidden="true"
  data-state="closed"
  data-testid="mobile-drawer"
>
  <!-- Backdrop with blur effect -->
  <div 
    id="drawer-backdrop"
    class="absolute inset-0 bg-background/80 backdrop-blur-lg transition-opacity duration-300 opacity-0"
    aria-hidden="true"
  ></div>
  
  <!-- Drawer Panel -->
  <div 
    class="absolute right-0 top-0 h-full w-full max-w-md bg-background/95 backdrop-blur-lg border-l border-border/40 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col pointer-events-auto"
    id="drawer-panel"
  >
    <div class="flex items-center justify-between p-4 border-b border-border/40">
      <h2 id="drawer-title" class="text-lg font-semibold text-foreground">Menu</h2>
      <button 
        id="drawer-close-button"
        class="btn-ghost w-10 h-10 p-0"
        aria-label="Close navigation menu"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
      </button>
    </div>
    
    <div class="flex-1 flex flex-col justify-between p-4">
      <nav class="flex flex-col space-y-2">
        {navLinks.map((item) => {
          const href = getHref(item.link);
          const isActive = currentPath === href;
          return (
            <a
              href={href}
              class={`px-4 py-3 text-base font-medium rounded-lg transition-colors hover:bg-accent hover:text-accent-foreground ${
                isActive ? 'bg-accent text-accent-foreground' : 'text-foreground/70'
              }`}
            >
              {item.name}
            </a>
          );
        })}
      </nav>
      
      <div class="mt-auto space-y-4 pt-4 border-t border-border/40">
        <a 
          href="/get-started" 
          class="btn-primary w-full justify-center"
          data-testid="drawer-cta"
        >
          Get Started
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  /**
   * Mobile drawer initialization and interaction logic.
   * Handles open/close, focus management, keyboard navigation, and scroll locking.
   * 
   * @module HeaderDrawer
   */
  
  const initDrawer = () => {
    const button = document.getElementById('mobile-menu-button');
    const drawer = document.getElementById('mobile-drawer');
    const panel = document.getElementById('drawer-panel');
    const backdrop = document.getElementById('drawer-backdrop');
    const closeBtn = document.getElementById('drawer-close-button');
    
    if (!button || !drawer || !panel || !backdrop || !closeBtn) return;

    /**
     * Gets all focusable elements within the drawer for focus trap.
     * @returns {HTMLElement[]} Array of focusable elements
     */
    const getFocusableElements = (): HTMLElement[] => {
      const selector = 'a[href], button:not([disabled]), [tabindex]:not([tabindex="-1"])';
      return Array.from(panel.querySelectorAll(selector));
    };

    /**
     * Stores the element that had focus before drawer opened.
     * Used to restore focus when drawer closes.
     */
    let previousFocusedElement: HTMLElement | null = null;

    /**
     * Opens the mobile drawer with proper state management and focus handling.
     */
    const open = () => {
      // Store current focus to restore later
      previousFocusedElement = document.activeElement as HTMLElement;
      
      // Update drawer state
      drawer.setAttribute('data-state', 'open');
      drawer.setAttribute('aria-hidden', 'false');
      drawer.classList.remove('pointer-events-none');
      button.setAttribute('aria-expanded', 'true');
      
      // Lock body scroll
      document.body.style.overflow = 'hidden';
      
      // Animate in
      requestAnimationFrame(() => {
        backdrop.classList.remove('opacity-0');
        panel.classList.remove('translate-x-full');
        
        // Set focus to close button after animation starts
        requestAnimationFrame(() => {
          closeBtn.focus();
        });
      });
    };

    /**
     * Closes the mobile drawer and restores previous state.
     */
    const close = () => {
      // Update drawer state
      drawer.setAttribute('data-state', 'closed');
      drawer.setAttribute('aria-hidden', 'true');
      button.setAttribute('aria-expanded', 'false');
      
      // Animate out
      backdrop.classList.add('opacity-0');
      panel.classList.add('translate-x-full');
      
      // Restore body scroll
      document.body.style.overflow = '';
      
      // Wait for animation to complete before removing pointer events
      setTimeout(() => {
        drawer.classList.add('pointer-events-none');
      }, 300);
      
      // Restore focus to hamburger button
      if (previousFocusedElement) {
        previousFocusedElement.focus();
        previousFocusedElement = null;
      }
    };

    /**
     * Handles keyboard navigation within the drawer.
     * Implements focus trap and Escape key to close.
     * 
     * @param {KeyboardEvent} e - The keyboard event
     */
    const handleKeyDown = (e: KeyboardEvent) => {
      const isOpen = drawer.getAttribute('data-state') === 'open';
      if (!isOpen) return;

      // Close on Escape
      if (e.key === 'Escape') {
        e.preventDefault();
        close();
        return;
      }

      // Focus trap on Tab
      if (e.key === 'Tab') {
        const focusableElements = getFocusableElements();
        if (focusableElements.length === 0) return;

        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];

        if (e.shiftKey) {
          // Shift+Tab: cycle backwards
          if (document.activeElement === firstElement) {
            e.preventDefault();
            lastElement.focus();
          }
        } else {
          // Tab: cycle forwards
          if (document.activeElement === lastElement) {
            e.preventDefault();
            firstElement.focus();
          }
        }
      }
    };

    // Event listeners
    button.onclick = open;
    closeBtn.onclick = close;
    backdrop.onclick = close;
    document.addEventListener('keydown', handleKeyDown);
  };

  // Initialize on page load and after Astro view transitions
  document.addEventListener('astro:page-load', initDrawer);
  initDrawer();
</script>

<style>
  /**
   * Drawer state-based visibility controls.
   * Uses pointer-events and opacity for smooth transitions.
   */
  
  /* Base state: invisible and unclickable */
  #drawer-backdrop {
    @apply opacity-0 pointer-events-none;
  }
  
  /* Closed state: ensure backdrop is hidden */
  #mobile-drawer[data-state="closed"] #drawer-backdrop {
    @apply opacity-0 pointer-events-none;
  }
  
  /* Open state: backdrop visible and clickable to close */
  #mobile-drawer[data-state="open"] #drawer-backdrop {
    @apply opacity-100 pointer-events-auto;
  }

  /* Panel pointer events based on drawer state */
  #mobile-drawer[data-state="closed"] #drawer-panel {
    @apply pointer-events-none;
  }

  #mobile-drawer[data-state="open"] #drawer-panel {
    @apply pointer-events-auto;
  }
</style>